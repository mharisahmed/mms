@model medicalsystem.Models.ProductSale

@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_mytemplate.cshtml";

}

<h3>Sale Master Details</h3>

@using (Html.BeginForm(null, null, FormMethod.Post, new { @id = "bookForm" }))
{
    @Html.AntiForgeryToken()
    <div class="form-horizontal">
        <hr />
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <div class="row col-md-12">
            <div class="col-md-10 col-md-offset-2">
                <div class="col-md-5 col-md-pull-1 ">
                    <div class="form-group input-group">
                        @*@Html.Label("CustomerName", htmlAttributes: new { @class = "control-label col-md-2" })*@
                        <span class="input-group-addon"><i class="fa fa-circle-o-notch"></i></span>
                        @Html.EditorFor(model => model.SaleMastert.CustomerName, new { htmlAttributes = new { @class = "form-control", @placeholder = "Enter Customer Name " } })
                        @* @Html.TextBox("CustomerName", model.SaleMastert.CustomerName, new { @class = "form-control" })*@

                    </div>
                </div>

                <div class="col-md-5 col-md-push-1 ">
                    <div class="form-group input-group">
                        <div class="DatePicker input-group input-append date" id="DatePicker">
                            <span class="input-group-addon add-on"><span class="glyphicon glyphicon-calendar"></span></span>
                            <input type="text" class="form-control" name="Date" placeholder="Date" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-10 col-md-offset-2">
                <div class="col-md-2 col-md-pull-1 ">
                    <div class="form-group input-group">
                        @*@Html.Label("Amount")*@
                        <span class="input-group-addon"><i class="fa fa-circle-o-notch"></i></span>
                        @Html.EditorFor(model => model.SaleMastert.Amount, new { htmlAttributes = new { @class = "form-control", @placeholder = "Amount ", @readonly = "readonly" } })
                        @* @Html.TextBox("Amount")*@
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group input-group">
                        @*@Html.Label("Remarks")*@
                        <span class="input-group-addon"><i class="fa fa-circle-o-notch"></i></span>
                        @Html.EditorFor(model => model.SaleMastert.Remarks, new { htmlAttributes = new { @class = "form-control", @placeholder = "Enter Remarks " } })
                        @*  @Html.TextBox("Remarks")*@
                    </div>
                </div>
                <div class="col-md-2 col-md-push-1 ">
                    <div class="form-group input-group">
                        @*@Html.Label("Discount")*@
                        <span class="input-group-addon"><i class="fa fa-circle-o-notch"></i></span>
                        @Html.EditorFor(model => model.SaleMastert.Discount, new { htmlAttributes = new { @class = "form-control", @placeholder = "Discount  " } })
                        @*  @Html.TextBox("Remarks")*@
                    </div>
                </div>
            </div>
        </div>
        <h4>Add Items Detail</h4>
        <div class="row col-md-10 col-md-offset-2" id="new_item">

            <div class="form-group col-md-9 col-md-offset-3">

                <div class="col-md-5">
                    @Html.DropDownList("Product", (IEnumerable<SelectListItem>)ViewBag.getProduct, "-- Select Item --", new { @class = "form-control", @id = "ddlproduct" })
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" name="txtQty" id="txtQty" placeholder="Qty" />
                </div>
                <div class="col-md-3">
                    <input type="text" class="form-control" name="txtPrice" id="txtCost" placeholder="Price" />
                </div>
                <div class="col-md-1">
                    <button id="additem" type="button" class="btn btn-default addButton"><i class="fa fa-plus"></i></button>
                </div>
            </div>
        </div>

        <div class="row col-md-10 col-md-offset-2" id="update_item">
            <h4>Update Items</h4>
            <div class="form-group">
                <input type="hidden" id="Urid" value="">
                <div class="form-group col-md-10 col-md-offset-2">

                    <div class="col-md-5">
                        @Html.DropDownList("Product", (IEnumerable<SelectListItem>)ViewBag.getProduct, "-- Select Item --", new { @class = "form-control", @id = "ddlproduct" })
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="txtQty" id="txtQty" placeholder="Qty" />
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" name="txtPrice" id="txtCost" placeholder="Price" />
                    </div>
                    <div class="col-md-1">
                        <button id="additem" type="button" class="btn btn-default addButton"><i class="fa fa-plus"></i></button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Table For Display Seleted Items-->
        <div class="row col-md-10 col-md-offset-2">
            <div class="table-responsive ">
                <table id="myTable" name="mytbl" class="table table-hover .table-condensed">
                    <tr>
                        <th>
                            Item
                        </th>
                        <th>
                            Qty
                        </th>
                        <th>
                            Price
                        </th>
                        <th>
                            Action
                        </th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <div class="form-group">
        <div class="col-md-offset-2 col-md-10">
            <input type="submit" value="Submit" class="btn btn-success" />
        </div>
    </div>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section pagescript{
<link href="~/Content/datepicker/datepicker.min.css" rel="stylesheet" />
<link href="~/Content/datepicker/datepicker3.min.css" rel="stylesheet" />
<script src="~/Content/datepicker/bootstrap-datepicker.min.js"></script>
    <script>
        $(document).ready(function () {

            //Initialize Total Amout With 0.0
            var totalamout = $('#SaleMastert_Amount');
            totalamout.val("0.0");

            // Initialize the date picker for the original due date field
            $(".DatePicker")
                .datepicker({
                    format: 'mm/dd/yyyy'
                })
                .on('changeDate', function (evt) {
                    // Revalidate the date field
                    $('#taskForm').formValidation('revalidateField', $('#dueDatePicker').find('[name="dueDate[]"]'));
                });


            //Hide Update Div.
            debugger;
            $("#update_item").hide();
            var uniqueid = 0;

            //Add Item To the Table.
            $("#additem").click(function () {

                $('#myTable tr:last').after('<tr id="' + uniqueid + '"> <td id=" txtproduct[' + uniqueid + ']">' + $('#ddlproduct :selected').text() + '<input name="Prid[' + uniqueid + ']" type="hidden" value="' + $('#ddlproduct :selected').val() + '"> </td>'
                                                                      + '<td id=" txtQty[' + uniqueid + ']">' + $('#txtQty').val() + '<input name="Qty[' + uniqueid + ']" type="hidden" value="' + $('#txtQty').val() + '"></td>'

                                                                       + '<td id=" txtCost[' + uniqueid + ']">' + $('#txtCost').val() + '<input name="Cost[' + uniqueid + ']" type="hidden" value="' + $('#txtCost').val() + '"></td>'
                                                                      + '<td> <button id="EditItem" type="button" class="btn btn-default EditItem"><i class="fa fa-edit"></i></button>'
                                                                          + '<button id="DeleteItem" type="button" class="btn btn-default DeleteItem"><i class="fa fa-remove"></i></button>' + '</td> </tr>');
                uniqueid += 1;
                var amount = parseInt($('#txtCost').val()) * parseInt($('#txtQty').val());
                totalamout.val(parseInt(totalamout.val()) + amount);
                cleartxts();
            });

            //Cancel Updation....
            $('#cancelupdateitem').click(function () {
                $("#new_item").show();
                $("#update_item").hide();
                var amount = parseInt($('#UpdatetxtCost').val()) * parseInt($('#UpdatetxtQty').val());
                totalamout.val(parseInt(totalamout.val()) + amount);
            });

            //Update Record.
            $('#saveUpdate').click(function () {
                var recordId = $('#Urid').val();
                var getworkingrow = $('#' + recordId);
                var amount = parseInt($('#UpdatetxtCost').val()) * parseInt($('#UpdatetxtQty').val());
                totalamout.val(parseInt(totalamout.val()) + amount);
                //update table items
                getworkingrow.find("td[id=' txtproduct[" + recordId + "]']").html($('#Updateddlproduct :selected').text());
                getworkingrow.find("td[id=' txtQty[" + recordId + "]']").html($('#UpdatetxtQty').val());
                getworkingrow.find("td[id=' txtCost[" + recordId + "]']").html($('#UpdatetxtCost').val());
                getworkingrow.find("td[id=' txtPrice[" + recordId + "]']").html($('#UpdatetxtPrice').val());
                getworkingrow.find("td[id=' txtMfg[" + recordId + "]']").html($('#UpdatetxtMfg').val());
                getworkingrow.find("td[id=' txtExp[" + recordId + "]']").html($('#UpdatetxtExp').val());
                getworkingrow.find("td[id=' txtBatch[" + recordId + "]']").html($('#UpdatetxtBatchNo').val());
                cleartxts();
                $("#new_item").show();
                $("#update_item").hide();
                alert('Record Updated!');
            });

            //Edit Items
            $('#myTable').on('click', '.EditItem', function () {
                $("#new_item").hide();
                $("#update_item").show();
                //var trid = $(this).closest('tr').attr('id');

                var recordId = $(this).closest('tr').attr('id');
                var currentrow = $('#' + recordId);
                var qty = currentrow.find("td[id=' txtQty[" + recordId + "]']").html();
                var amount = currentrow.find("td[id=' txtCost[" + recordId + "]']").html();

                var subamount = parseInt(qty) * parseInt(amount);
                totalamout.val(parseInt(totalamout.val()) - subamount);

                $('#Urid').val(recordId)
                var val = $(this).closest('tr').find('td:eq(0)').html();
                //var val1 = $(this).closest('tr').find('td:eq(0)').html();

                //$("#Updateddlproduct option").each(function () {
                //    if ($(this).text() == val) {
                //        $(this).attr('selected', 'selected').siblings().removeAttr('selected');
                //    }
                //}); //Prid

                $('#UpdatetxtQty').val($(this).closest('tr').find("input[name*='Prid']").val());
                $('#UpdatetxtQty').val($(this).closest('tr').find("input[name*='Qty']").val());
                $('#UpdatetxtCost').val($(this).closest('tr').find("input[name*='Cost']").val());
                $('#UpdatetxtPrice').val($(this).closest('tr').find("input[name*='Price']").val());
                $('#UpdatetxtMfg').val($(this).closest('tr').find("input[name*='Mfg']").val());
                $('#UpdatetxtExp').val($(this).closest('tr').find("input[name*='Exp']").val());
                $('#UpdatetxtBatchNo').val($(this).closest('tr').find("input[name*='Batch']").val());

            });

            //Delete items From Tables.
            $('#myTable').on('click', '.DeleteItem', function () {
                var recordId = $(this).closest('tr').attr('id');
                var currentrow = $('#' + recordId);
                var qty = currentrow.find("td[id=' txtQty[" + recordId + "]']").html();
                var amount = currentrow.find("td[id=' txtCost[" + recordId + "]']").html();

                var subamount = parseInt(qty) * parseInt(amount);
                totalamout.val(parseInt(totalamout.val()) - subamount);

                if (totalamout.val() == "" && totalamout.val() == 0) {
                    totalamout.val("0.0");
                }

                $(this).closest('tr').remove();
            });


            function cleartxts() {
                $('#ddlproduct :selected').val($("#ddlproduct option:first").val());
                $('#txtQty').val("");
                $('#txtCost').val("");
                $('#txtPrice').val("");
                $('#txtMfg').val("");
                $('#txtExp').val("");
                $('#txtBatchNo').val("");

                $('#Updateddlproduct :selected').val($("#Updateddlproduct option:first").val());
                $('#UpdatetxtQty').val("");
                $('#UpdatetxtCost').val("");
                $('#UpdatetxtPrice').val("");
                $('#UpdatetxtMfg').val("");
                $('#UpdatetxtExp').val("");
                $('#UpdatetxtBatchNo').val("");
            }

            //Ready Function.....
        });
    </script>

}